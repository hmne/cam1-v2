"use strict";!function(e,t){const n=e.CAMERA_NAME||"Camera",o=2e3,i=1500,a=25,r=200,s=200,l=7,c=7,u=500,d=800,v={"very-low":[480,360,8],low:[640,480,16],medium:[800,600,24],high:[1024,768,32]},m={statusInterval:null,webLiveInterval:null,sessionHeartbeatInterval:null,isLiveActive:!1,lastOnlineTime:Date.now(),wasLiveBeforeOffline:!1,captureLock:!1,liveErrorCount:0,currentQuality:null,statusRetryCount:0,firstLoad:!0,sessionId:null},f=e=>t.querySelector(e);function p(e){const t={method:"GET",headers:{},timeout:5e3,cache:!1,...e};if(!1===t.cache&&"GET"===t.method){const e=t.url.includes("?")?"&":"?";t.url+=e+"t="+Date.now()}const n={method:t.method,headers:t.headers};if(t.data&&"POST"===t.method)if("object"==typeof t.data){const e=new URLSearchParams;for(const n in t.data)e.append(n,t.data[n]);n.body=e}else n.body=t.data;const o=new Promise(((e,n)=>setTimeout((()=>n(new Error("Request timeout"))),t.timeout)));return Promise.race([fetch(t.url,n),o]).then((e=>!e.ok&&t.error?(t.error({status:e.status}),null):"json"===t.dataType?e.json():e.text())).then((e=>(null!==e&&t.success&&t.success(e),t.complete&&t.complete(),e))).catch((e=>{t.error&&t.error({status:0,error:e.message}),t.complete&&t.complete()}))}function g(){p({url:"tmp/web_live.tmp",method:"GET",success:function(e){const t="on"===e.trim()?"on":"off",o=f("#webLiveSelect");o&&(o.value=t),"on"===t&&p({url:"tmp/web_live_session.tmp",method:"GET",success:function(e){if(e){const t=e.trim().split(":"),o=parseInt(t[0])||0;Date.now()-o<6e4&&(console.log(`[${n}] Session active - starting live`),toggleWebLive())}}})},error:function(){const e=f("#webLiveSelect");e&&(e.value="off")}}),I()}function L(){t.addEventListener("keydown",(function(e){if(!e.target.matches("input, textarea, select")&&(32===e.keyCode&&(e.preventDefault(),captureImage()),76===e.keyCode)){const e=f("#webLiveSelect");if(e){const t="on"===e.value?"off":"on";e.value=t,toggleWebLive()}}})),function(){const t=f("#webLiveSelect");t&&t.addEventListener("change",(function(){toggleWebLive()}));const n=f("#liveQuality");n&&n.addEventListener("change",(function(){updateLiveQuality(!0)}));const o=f("#myBut");o&&o.addEventListener("click",(function(){captureImage()}));const i=f("#rebootButton");i&&i.addEventListener("click",(function(){confirm("Are you sure you want to reboot the camera?")&&(this.disabled=!0,this.textContent="Rebooting...",p({url:"admin/reboot.php?token="+encodeURIComponent(e.ADMIN_TOKEN),method:"GET",dataType:"json",success:e=>{alert(e.message||e.error||"Operation completed")},error:e=>{alert(e.error||"Failed to reboot camera")},complete:()=>{this.disabled=!1,this.textContent="Reboot"}}))}));const a=f("#shutdownButton");a&&a.addEventListener("click",(function(){confirm("If you turn off the camera, it will not work unless you turn it off and then on again via the switch.\nAre you sure?")&&(this.disabled=!0,this.textContent="Shutting down...",p({url:"admin/shutdown.php?token="+encodeURIComponent(e.ADMIN_TOKEN),method:"GET",dataType:"json",success:e=>{alert(e.message||e.error||"Operation completed")},error:e=>{alert(e.error||"Failed to shutdown camera")},complete:()=>{this.disabled=!1,this.textContent="Shutdown"}}))}));const r=f("#clearFilesButton");r&&r.addEventListener("click",(function(){e.location.href="admin/clear.php"}))}()}function w(){e.addEventListener("beforeunload",(function(){if(m.statusInterval&&clearInterval(m.statusInterval),m.webLiveInterval&&clearInterval(m.webLiveInterval),m.sessionHeartbeatInterval&&clearInterval(m.sessionHeartbeatInterval),m.isLiveActive){const e=new URLSearchParams;e.append("action","write"),e.append("file","tmp/web_live.tmp"),e.append("data","off"),navigator.sendBeacon("index.php",e)}}))}function b(){m.statusInterval&&clearInterval(m.statusInterval),m.statusInterval=setInterval((function(){I(),e.navigator.onLine||alert("Web browser without internet connection\n\nTry to:\nCheck network cables, modem and router\nReconnect to a Wi-Fi network"),m.isLiveActive&&p({url:"tmp/web_live_session.tmp",method:"GET",timeout:3e3,success:function(e){const t=e.trim();if(!t)return;const o=t.split(":"),i=parseInt(o[0])||0,a=o[1]||"";if(a&&a!==m.sessionId&&Date.now()-i<3e4){console.log(`[${n}] Live stream opened elsewhere - stopping here (session conflict)`);const e=f("#webLiveSelect");e&&(e.value="off"),x()}},error:function(){}})}),o)}function I(){p({url:"mode.php",method:"GET",timeout:5e3,success:function(e){m.statusRetryCount=0,m.firstLoad=!1;const n=f("#id1");n&&(n.innerHTML=e,function(e){e.querySelectorAll("script").forEach((e=>{const n=t.createElement("script");e.src?n.src=e.src:n.textContent=e.textContent,e.parentNode.replaceChild(n,e)}))}(n)),h()},error:function(t){if(m.statusRetryCount<2)return m.statusRetryCount++,void setTimeout(I,200);if(!m.firstLoad){const e=f("#id1");e&&(e.innerHTML='<span class="camera-offline">Camera Offline</span>')}console.log(`[${n}] mode.php load error - HTTP ${t.status}`),e.cameraOnlineStatus=!1,e.secondsSinceUpdate=999,m.statusRetryCount=0,m.firstLoad=!1,h()}})}function h(){const t=e.cameraOnlineStatus||!1,o=e.secondsSinceUpdate||999,i=Date.now();if(t&&o<=l){if(m.lastOnlineTime=i,m.wasLiveBeforeOffline&&!m.isLiveActive){console.log(`[${n}] üîÑ Camera back online - restarting live stream`),m.wasLiveBeforeOffline=!1;const e=f("#webLiveSelect");e&&(e.value="on"),$()}}else{const e=(i-m.lastOnlineTime)/1e3;e>l&&m.isLiveActive&&(console.log(`[${n}] ‚è∏Ô∏è Camera offline for ${e.toFixed(0)}s - stopping live stream`),m.wasLiveBeforeOffline=!0,k())}}function y(e,o,i,l,c){if(l>=s)return console.warn(`[${n}] ‚è±Ô∏è Timeout after ${l} attempts`),T(e,o),C(c),void alert("Image capture timed out. The Camera may be busy or offline. Please try again.");p({url:"index.php?check_new_image",method:"GET",success:function(s){if("0"!==s){const a=parseInt(s,10);if(a>i){const r=(a-i).toFixed(2);console.log(`[${n}] ‚úÖ Image received in ${r}s (timestamp: ${a})`),function(e,n){const o=e+"_"+Date.now()+"_"+Math.random().toString(36).substr(2,9);let i=f("#ImageContainer"),a=f("#imageDetails"),r=f("#Image");const s=!!(i&&a&&r);i||(i=t.createElement("div"),i.id="ImageContainer",i.className="glass-panel",i.innerHTML='\n                <img id="Image" alt="Captured Image" loading="eager" class="captured-image">\n            ');a||(a=t.createElement("div"),a.id="imageDetails",a.className="glass-panel image-details-panel");if(a.innerHTML='\n            <p id="imageSizeText" class="image-size-text">Loading image size...</p>\n        ',!s){const e=f("form");if(e){const t=e.closest(".glass-panel");t&&(t.insertAdjacentElement("afterend",i),i.insertAdjacentElement("afterend",a))}}const l=new Image;let c=0;const u=3;l.onload=function(){r=f("#Image"),r&&(r.src=this.src,i.style.display="block",a.style.display="block"),p({url:"index.php?get_image_size=1",method:"GET",success:function(e){const t=f("#imageSizeText");t&&(t.className="data-text",t.innerHTML=`Image size: ${e} <span class="capture-time">${n}s</span>`)},error:function(){const e=f("#imageSizeText");e&&(e.innerHTML=`Image size: Unknown <span class="capture-time">${n}s</span>`)}})},l.onerror=function(){c++;const e=f("#imageSizeText");c<=u?(e&&(e.textContent="Loading image... ("+c+"/"+u+")"),setTimeout((function(){l.src="pic.jpg?v="+Date.now()+"_retry"+c}),1e3)):e&&(e.textContent="Error: Could not load image")},l.src="pic.jpg?v="+o}(a,r),T(e,o),c&&(console.log(`[${n}] ‚ñ∂Ô∏è Restarting live stream...`),setTimeout((function(){const e=f("#webLiveSelect");e&&(e.value="on"),toggleWebLive()}),u))}else setTimeout((function(){y(e,o,i,l+1,c)}),r)}else setTimeout((function(){y(e,o,i,l+1,c)}),a)},error:function(){setTimeout((function(){y(e,o,i,l+1,c)}),r)}})}function T(e,t){m.captureLock=!1,e&&(e.disabled=!1,e.textContent=t,e.classList.remove("blinking"))}function C(e){if(e){const e=f("#webLiveSelect");e&&(e.value="on"),toggleWebLive()}}function S(){if(!m.isLiveActive||!m.sessionId)return;p({url:"index.php",method:"POST",data:{action:"write",file:"tmp/web_live_session.tmp",data:Date.now()+":"+m.sessionId}})}function E(){m.sessionHeartbeatInterval&&(clearInterval(m.sessionHeartbeatInterval),m.sessionHeartbeatInterval=null),m.sessionId=null}function $(){console.log(`[${n}] üé• Starting live stream...`),m.isLiveActive=!0,m.sessionId=Date.now()+"_"+Math.random().toString(36).substr(2,9),S(),m.sessionHeartbeatInterval&&clearInterval(m.sessionHeartbeatInterval),m.sessionHeartbeatInterval=setInterval(S,1e4);const e=f("#webLiveContainer"),o=f("#webLiveImage");e&&(e.style.display="block"),o&&(o.src="buffer.jpg");const i=f("#liveFeed");if(i&&!f("#loadingIndicator")){const e=t.createElement("div");e.id="loadingIndicator",e.className="loading-overlay",e.innerHTML='\n                <div class="spinner"></div>\n                <div class="loading-text">Starting live stream...</div>\n            ',i.appendChild(e)}const a=localStorage.getItem("preferredQuality"),r=f("#liveQuality");r&&(r.value=a||"very-low"),updateLiveQuality(!1),p({url:"index.php",method:"POST",data:{action:"write",file:"tmp/web_live.tmp",data:"on"},success:function(e){if("OK"===e.trim())console.log(`[${n}] ‚ñ∂Ô∏è Live stream ready`),setTimeout((function(){const e=f("#loadingIndicator");e&&e.remove(),O()}),d);else{console.error(`[${n}] ‚ùå Failed to start: ${e}`);const t=f("#loadingIndicator");t&&t.remove(),alert("Failed to start live stream: "+e)}},error:function(e){console.error(`[${n}] ‚ùå Failed to start:`,e.error);const t=f("#loadingIndicator");t&&t.remove(),alert("Failed to start live stream: "+e.error)}})}function x(){console.log(`[${n}] ‚èπÔ∏è Live stream OFF (user stopped)`),m.isLiveActive=!1,E(),m.webLiveInterval&&clearInterval(m.webLiveInterval);const e=f("#webLiveContainer"),t=f("#loadingIndicator");e&&(e.style.display="none"),t&&t.remove(),p({url:"index.php",method:"POST",data:{action:"write",file:"tmp/web_live.tmp",data:"off"}})}function k(){console.log(`[${n}] ‚è∏Ô∏è Live stream paused (connection timeout)`),m.isLiveActive=!1,E(),m.webLiveInterval&&clearInterval(m.webLiveInterval);const e=f("#webLiveImage"),t=f("#loadingIndicator");e&&(e.src="buffer.jpg"),t&&t.remove()}function O(){m.webLiveInterval&&clearInterval(m.webLiveInterval),A(),m.webLiveInterval=setInterval((function(){const e=f("#webLiveSelect");m.isLiveActive&&e&&"on"===e.value?A():(clearInterval(m.webLiveInterval),m.webLiveInterval=null)}),i)}function A(){const e=f("#webLiveSelect");if(!e||"on"!==e.value||!m.isLiveActive)return;const t=new Image;t.onload=function(){const e=f("#webLiveImage");e&&(e.src=this.src),m.liveErrorCount>0&&(console.log(`[${n}] ‚úÖ Live stream recovered`),m.liveErrorCount=0)},t.onerror=function(){m.liveErrorCount++,console.warn(`[${n}] ‚ö†Ô∏è Live image load failed (attempt ${m.liveErrorCount})`),m.liveErrorCount>=c&&(console.error(`[${n}] ‚ùå Live stream timeout - stopping after ${c} failed attempts`),k(),m.liveErrorCount=0)},t.src="live.jpg?"+Date.now()}e.captureImage=function(){if(m.captureLock)return void console.log(`[${n}] ‚ö†Ô∏è captureImage() ignored: capture already in progress`);const e=f("#webLiveSelect"),t=e?e.value:"off";let o=!1;"on"===t&&m.isLiveActive&&(o=!0,console.log(`[${n}] üõë Stopping live stream for capture...`),m.isLiveActive=!1,m.webLiveInterval&&clearInterval(m.webLiveInterval),e&&(e.value="off"),p({url:"index.php",method:"POST",data:{action:"write",file:"tmp/web_live.tmp",data:"off"}})),m.captureLock=!0;const i=f("#myBut"),a=i?i.textContent:"Capture";i&&(i.disabled=!0,i.textContent="Capturing...",i.classList.add("blinking"));const r=Date.now()/1e3;p({url:"index.php",method:"POST",data:{res:f('select[name="res"]')?.value,comp:f('select[name="comp"]')?.value,iso:f('select[name="iso"]')?.value,sat:f('select[name="sat"]')?.value,rot:f('select[name="rot"]')?.value,fx:f('select[name="fx"]')?.value,enf:f('select[name="enf"]')?.value,b1:"inic",submit:"submit"},success:function(e){if("BUSY"===e)return console.warn(`[${n}] ‚ö†Ô∏è Server responded BUSY`),T(i,a),C(o),void alert("Camera is busy. Please wait and try again.");y(i,a,r,0,o)},error:function(e){console.error(`[${n}] ‚ùå Capture POST failed:`,e),T(i,a),C(o),alert("Failed to capture image. Please try again.")}})},e.toggleWebLive=function(){const e=f("#webLiveSelect");if(!e)return;"on"===e.value?$():x()},e.updateLiveQuality=function(e){const t=f("#liveQuality");if(!t)return;const o=t.value,i=v[o]||v["very-low"],a=i[0],r=i[1],s=i[2],l=a+" "+r+" "+s;(e||m.currentQuality!==l)&&(m.currentQuality=l,localStorage.setItem("preferredQuality",o),p({url:"index.php",method:"POST",data:{action:"write",file:"tmp/web_live_quality.tmp",data:l},success:function(t){"OK"===t.trim()?(console.log(`[${n}] ‚úÖ Quality set: ${a}x${r} q=${s}`),e&&m.webLiveInterval&&m.isLiveActive&&setTimeout((function(){const e=f("#webLiveImage");e&&(e.src="buffer.jpg"),setTimeout((function(){O()}),500)}),500)):console.error(`[${n}] ‚ùå Server response: ${t}`)},error:function(e){console.error(`[${n}] ‚ùå Quality update failed:`,e.error)}}))},"loading"===t.readyState?t.addEventListener("DOMContentLoaded",(function(){g(),L(),b(),w()})):(g(),L(),b(),w())}(window,document);
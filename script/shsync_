#!/usr/bin/env bash

set -euo pipefail
IFS=$'\n\t'

#===============================================================================
# DEVICE CONFIGURATION
#===============================================================================
readonly DEVICE_ID="${DEVICE_ID:-cam1}"
readonly BASE_URL="http://netstorm.site/${DEVICE_ID}"

#===============================================================================
# Cleanup trap
#===============================================================================
cleanup() {
    local pids
    pids="$(jobs -p 2>/dev/null)" || :
    [[ -n $pids ]] && {
        echo "$pids" | xargs -r kill -TERM 2>/dev/null || :
        echo "$pids" | xargs -r wait 2>/dev/null || :
    }
    exit "${1:-0}"
}
trap 'cleanup $?' EXIT INT TERM

#===============================================================================
# Functions
#===============================================================================

# Check internet connectivity
check_internet() {
    ping -q -c 1 -W 1 9.9.9.9 >/dev/null 2>&1
}

# Get WiFi signal quality (Pure Bash)
get_wifi_quality() {
    local signal_line level
    signal_line="$(iwconfig wlan0 2>/dev/null)" || { echo "Unknown"; return; }

    [[ $signal_line =~ Signal\ level=(-?[0-9]+) ]] && level="${BASH_REMATCH[1]#-}" || { echo "Unknown"; return; }

    if ((level >= 70)); then echo "Bad"
    elif ((level >= 60)); then echo "Regular"
    elif ((level >= 50)); then echo "Good"
    elif ((level >= 40)); then echo "Very Good"
    else echo "Excellent"
    fi
}

# Get TX bytes (Pure Bash)
get_tx_bytes() {
    local ifconfig_out
    ifconfig_out="$(ifconfig wlan0 2>/dev/null)" || { echo "N/A"; return; }

    [[ $ifconfig_out =~ TX[^(]*\(([^)]+)\) ]] && echo "${BASH_REMATCH[1]}" || echo "N/A"
}

# Get CPU temperature (Pure Bash)
get_cpu_temp() {
    local temp_file="/sys/class/thermal/thermal_zone0/temp"
    [[ -r $temp_file ]] && echo "$(($(< "$temp_file") / 1000))Â°C" || echo "N/A"
}

# Get ping time (Pure Bash)
get_ping_time() {
    local ping_out
    ping_out="$(ping -c 1 -W 1 netstorm.site 2>/dev/null)" || { echo "N/A"; return; }

    [[ $ping_out =~ time=([0-9.]+[[:space:]]*ms) ]] && echo "${BASH_REMATCH[1]}" || echo "N/A"
}

# Upload data with retry - FIXED: Add tmp/ prefix for routing
upload_data() {
    local file=$1 data=$2 attempt=0

    # Add tmp/ prefix if not already present for proper routing in storage.php
    [[ $file != tmp/* ]] && file="tmp/${file}"

    while ((attempt++ < 2)); do
        curl -sf -H 'Cache-Control: no-cache' --data "file=${file}&data=${data}" "${BASE_URL}/storage.php" -m 10 >/dev/null 2>&1 && return 0
        sleep 1
    done
    return 1
}

# Sync tunnel URLs
sync_tunnel_urls() {
    local file data
    for file in url.tmp url2.tmp url3.tmp url4.tmp ssh2.tmp; do
        [[ -f $file ]] || continue
        data="$(<"$file")"
        upload_data "$file" "$data" &
    done
    wait
}

#===============================================================================
# Main Loop
#===============================================================================
main() {
    while true; do
        if check_internet; then
            # Gather system stats
            local tx_bytes cpu_temp ping_time wifi_quality status_data

            tx_bytes="$(get_tx_bytes)"
            cpu_temp="$(get_cpu_temp)"
            ping_time="$(get_ping_time)"
            wifi_quality="$(get_wifi_quality)"

            # Build status string
            status_data="${tx_bytes},${cpu_temp},${ping_time},${wifi_quality}"

            # Update local and remote status
            echo "$status_data" > status.tmp 2>/dev/null || :
            upload_data "status.tmp" "$status_data" &

            # Sync tunnel URLs
            sync_tunnel_urls
        fi

        sleep 10
    done
}

main "$@"

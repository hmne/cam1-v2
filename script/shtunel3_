#!/usr/bin/env bash

#===============================================================================
# PAGEKITE TUNNEL SCRIPT - Server 3
#===============================================================================
set -Eeuo pipefail


#===============================================================================
# CONFIG
#===============================================================================
readonly DEVICE_ID="${DEVICE_ID:-cam1}"
readonly T_MODE="${T_MODE:-both}"
readonly BASE_URL="http://netstorm.site/${DEVICE_ID}"
readonly T_PORT="80"
readonly S_PORT="22"
readonly KITE_NAME="nscam.pagekite.me"
readonly KITE_SECRET="698k2f4xa8cfk7b8a8xx7ffakkefke93"

readonly INSTALL_DIR="/tmp"
readonly TEMP_DIR="/tmp"
readonly PAGEKITE_BIN="${INSTALL_DIR}/pagekite.py"
readonly CONFIG_FILE="${TEMP_DIR}/pagekite.rc"
readonly URL_FILE="${TEMP_DIR}/url3.tmp"
readonly LOG_FILE="${TEMP_DIR}/pagekite.log"
readonly MAX_RETRIES=3
readonly RETRY_DELAY=2
readonly TIMEOUT=30

# Export for external use
export DEVICE_ID BASE_URL


#===============================================================================
# TRAP HANDLERS
#===============================================================================
cleanup() {
    local exit_code=${1:-$?}

    log "INFO" "Cleaning up PageKite processes"
    pkill -f pagekite 2>/dev/null || :
    rm -f "$URL_FILE" "$CONFIG_FILE"
    find /tmp -name "pagekite*" -type f -delete 2>/dev/null || :

    exit "$exit_code"
}


err_trap() {
    local exit_code=$? line="${BASH_LINENO[0]}" func="${FUNCNAME[1]:-main}"
    log "ERROR" "${func}():${line} failed (exit $exit_code)"
}


trap 'cleanup $?' EXIT INT TERM
trap err_trap ERR


#===============================================================================
# LOGGING
#===============================================================================
log() {
    local level="$1" msg="$2"
    local timestamp
    timestamp=$(TZ=Asia/Kuwait date '+%Y-%m-%d %H:%M:%S')
    printf '[%s] [%s] %s\n' "$timestamp" "$level" "$msg" | tee -a "$LOG_FILE"
}


#===============================================================================
# FUNCTIONS
#===============================================================================

# Install PageKite with parallel download attempts
install_pagekite() {
    log "INFO" "Checking PageKite installation"

    if [[ -f $PAGEKITE_BIN ]]; then
        log "INFO" "Found existing PageKite binary"
        return 0
    fi

    local attempt

    for attempt in {1..3}; do
        log "INFO" "Download attempt $attempt/3 from custom source"

        if wget -q "$BASE_URL/downloads/pagekite.py" -O "$PAGEKITE_BIN" 2>/dev/null; then
            chmod +x "$PAGEKITE_BIN"

            # Verify file size
            local file_size
            file_size=$(stat -c%s "$PAGEKITE_BIN" 2>/dev/null || echo 0)

            if [[ $file_size -ge 10000 ]]; then
                log "INFO" "Successfully installed PageKite from custom source (${file_size} bytes)"
                return 0
            fi

            log "WARN" "Downloaded file too small ($file_size bytes), retry $attempt/3"
            rm -f "$PAGEKITE_BIN"
        fi

        sleep 1
    done

    log "INFO" "Trying official download"
    if wget -q "https://pagekite.net/pk/pagekite.py" -O "$PAGEKITE_BIN" 2>/dev/null; then
        chmod +x "$PAGEKITE_BIN"

        # Verify file size
        local file_size
        file_size=$(stat -c%s "$PAGEKITE_BIN" 2>/dev/null || echo 0)

        if [[ $file_size -ge 10000 ]]; then
            log "INFO" "Successfully installed PageKite from official source (${file_size} bytes)"
            return 0
        fi
    fi

    log "ERROR" "Failed to install PageKite from any source"
    return 1
}


# Create PageKite configuration
create_config() {
    log "INFO" "Creating PageKite configuration"

    cat > "$CONFIG_FILE" <<EOF
###[ Current settings for pagekite.py v1.5.2.201011. ]#########
## Disable TLS certificate verification entirely
fe_nocertcheck

##[ Default kite and account details ]##
kitename   = $KITE_NAME
kitesecret = $KITE_SECRET

##[ Front-end settings: use pagekite.net defaults ]##
defaults

##[ Back-ends and local services ]##
EOF

    if [[ $T_MODE != "ssh" ]]; then
        echo "service_on  = http:$KITE_NAME:localhost:$T_PORT:$KITE_SECRET" >> "$CONFIG_FILE"
        log "INFO" "Added HTTP service configuration"
    fi

    if [[ $T_MODE != "http" ]]; then
        echo "service_on  = raw-22:ssh.$KITE_NAME:localhost:$S_PORT:$KITE_SECRET" >> "$CONFIG_FILE"
        log "INFO" "Added SSH service configuration"
    fi

    # Shell service
    echo "service_on  = http:shell.$KITE_NAME:localhost:4200:$KITE_SECRET" >> "$CONFIG_FILE"
    log "INFO" "Added Shell service configuration"

    cat >> "$CONFIG_FILE" <<EOF

##[ Miscellaneous settings ]##
savefile = $CONFIG_FILE
max_read_bytes = 16256x3.100

#########[ End of pagekite.py configuration ]#########
EOF

    log "INFO" "Configuration file created successfully"
}


# Start tunnel with retry
start_tunnel() {
    local attempt

    # Clean up existing processes (but don't call full cleanup trap)
    pkill -f pagekite 2>/dev/null || :
    rm -f "$URL_FILE" "$CONFIG_FILE"

    if [[ ! -f $PAGEKITE_BIN ]]; then
        if ! install_pagekite; then
            log "ERROR" "Failed to install PageKite"
            return 1
        fi
    fi

    create_config

    for attempt in $(seq 1 "$MAX_RETRIES"); do
        log "INFO" "Starting PageKite tunnel (attempt $attempt/$MAX_RETRIES)"

        "$PAGEKITE_BIN" --clean --optfile "$CONFIG_FILE" > "$LOG_FILE" 2>&1 &
        local pagekite_pid=$!
        log "INFO" "PageKite started with PID: $pagekite_pid"

        local wait_count=0
        while [[ $wait_count -lt $TIMEOUT ]]; do
            if ps -p "$pagekite_pid" > /dev/null 2>&1; then
                if [[ $T_MODE != "ssh" ]]; then
                    echo "http://$KITE_NAME" > "$URL_FILE"
                    log "INFO" "HTTP tunnel established: http://$KITE_NAME"
                fi

                sleep 0.2  # Service stabilization delay
                return 0
            fi
            sleep 1
            ((wait_count++))
        done

        log "WARN" "Tunnel attempt $attempt failed"

        # Clean up for retry
        pkill -f pagekite 2>/dev/null || :
        rm -f "$URL_FILE" "$CONFIG_FILE"

        if [[ $attempt -lt $MAX_RETRIES ]]; then
            log "INFO" "Waiting ${RETRY_DELAY}s before retry"
            sleep "$RETRY_DELAY"
        fi
    done

    log "ERROR" "Failed to establish tunnel after $MAX_RETRIES attempts"
    return 1
}


# Monitor tunnel health
monitor_tunnel() {
    log "INFO" "Starting tunnel monitoring"

    while true; do
        if ! pgrep -f pagekite >/dev/null 2>&1; then
            log "WARN" "PageKite process not found, restarting"
            if ! start_tunnel; then
                log "ERROR" "Failed to restart tunnel"
            fi
        fi
        sleep 30
    done
}


#===============================================================================
# MAIN
#===============================================================================
main() {
    log "INFO" "=== SERVER 3 (PAGEKITE) STARTING ==="

    # Start tunnel
    if ! start_tunnel; then
        log "ERROR" "Server 3 initial startup failed"
        exit 1
    fi

    # Keep tunnel alive
    monitor_tunnel
}


main "$@"

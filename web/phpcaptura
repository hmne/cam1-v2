<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <title>N.S Cam1 Control - Tunnel</title>
    <link rel="preload" href="file.css" as="style">
    <link rel="stylesheet" type="text/css" href="file.css">
    <link rel="shortcut icon" type="image/x-icon" href="logo.ico">
    <script src="jquery-3.7.1.min.js"></script>
    <script>
    $(document).ready(function() {
        var refreshId = setInterval(function() {
            var ifConnected = window.navigator.onLine;
            if (ifConnected) {} else {
                alert('Web browser without internet connection\n\nTry to:\nCheck network cables, modem and router\nReconnect to a Wi-Fi network');
            }
        }, 5000);
        $.ajaxSetup({ cache: false });
    });
    </script>
</head>
<body>

<?php
$b1="";
if(isset($_POST['submit']))
{
$res=$_POST['res'];
$comp=$_POST['comp'];
$iso=$_POST['iso'];
$sat=$_POST['sat'];
$rot=$_POST['rot'];
$fx=$_POST['fx'];
$enf=$_POST['enf'];
$b1=$_POST['b1'];
file_put_contents('var.tmp', $res . " ".$comp . " ". $iso . " ". $sat. " " . $rot . " ". $fx. " " . $enf);
}
$data = file_get_contents('var.tmp');
$mon = file_get_contents('monitor.tmp');
$bits = explode(" ", $data);
?>

<div class="page pinch-zoom-parent"><div class="pinch-zoom">
<center><h1>N.S Cam1 Control - Tunnel</h1></center>

<form id="myForm" method="post" action="<?php echo $_SERVER['PHP_SELF']; ?>" target="_top">
<center><p><br>
<label for="mon">Live</label>
<select name="mon" id="mySelect" onchange="myFunction2()">
<option <?php if ($mon == "off" ) echo 'selected' ; ?> value="off">No</option>
<option <?php if ($mon == "on" ) echo 'selected' ; ?> value="on">Yes</option>
</select>

<label for="res">Resolution</label>
<select name="res">
<option <?php if ($bits[0] == 1 ) echo 'selected' ; ?> value="1">1280x960</option>
<option <?php if ($bits[0] == 2 ) echo 'selected' ; ?> value="2">1920x1440</option>
<option <?php if ($bits[0] == 3 ) echo 'selected' ; ?> value="3">2592x1944</option>
<option <?php if ($bits[0] == 4 ) echo 'selected' ; ?> value="4">3200x2400</option>
</select>

<label for="comp">&nbsp;Compression</label>
<select name="comp">
<option <?php if ($bits[1] == 20 ) echo 'selected' ; ?> value="20">Low</option>
<option <?php if ($bits[1] == 15 ) echo 'selected' ; ?> value="15">Medium</option>
<option <?php if ($bits[1] == 10 ) echo 'selected' ; ?> value="10">High</option>
<option <?php if ($bits[1] == 5 ) echo 'selected' ; ?> value="5">Very High</option>
</select>

<label for="iso">&nbsp;FPS</label>
<select name="iso">
<option <?php if ($bits[2] == 0 ) echo 'selected' ; ?> value="0">Auto</option>
<option <?php if ($bits[2] == 33333 ) echo 'selected' ; ?> value="33333">30</option>
<option <?php if ($bits[2] == 16666 ) echo 'selected' ; ?> value="16666">60</option>
<option <?php if ($bits[2] == 8333 ) echo 'selected' ; ?> value="8333">120</option>
<option <?php if ($bits[2] == 4166 ) echo 'selected' ; ?> value="4166">240</option>
<option <?php if ($bits[2] == 2083 ) echo 'selected' ; ?> value="2083">480</option>
<option <?php if ($bits[2] == 1042 ) echo 'selected' ; ?> value="1042">960</option>
</select><br><br>

<label for="sat">Image</label>
<select name="sat">
<option <?php if ($bits[3] == "-35" ) echo 'selected' ; ?> value="-35">Color</option>
<option <?php if ($bits[3] == "-100" ) echo 'selected' ; ?> value="-100">Gray</option>
</select>

<label for="rot">&nbsp;Rotation</label>
<select name="rot">
<option <?php if ($bits[4] == 270 ) echo 'selected' ; ?> value="270">-90</option>
<option <?php if ($bits[4] == 0 ) echo 'selected' ; ?> value="0">0</option>
<option <?php if ($bits[4] == 90 ) echo 'selected' ; ?> value="90">90</option>
<option <?php if ($bits[4] == 180 ) echo 'selected' ; ?> value="180">180</option>
</select>

<label for="fx">&nbsp;Effect</label>
<select name="fx">
<option <?php if ($bits[5] == "none" ) echo 'selected' ; ?> value="none">Normal</option>
<option <?php if ($bits[5] == "negative" ) echo 'selected' ; ?> value="negative">Negative</option>
</select>

<label for="enf">&nbsp;Sharpness</label>
<select name="enf">
<option <?php if ($bits[6] == 25 ) echo 'selected' ; ?> value="25">Normal</option>
<option <?php if ($bits[6] == 75 ) echo 'selected' ; ?> value="75">Medium</option>
<option <?php if ($bits[6] == 100 ) echo 'selected' ; ?> value="100">High</option>
</select><br><br>

<button id="myBut3" style="display:none" onclick="myFunction3()" type="submit" name="submit">Update Monitor Settings</button>

<span id="mon"></span>

<input id="myValue" type="hidden" name="b1" value="">
<button id="myBut" onclick="myFunction1()" type="submit" name="submit" style="background: rgba(255,0,0,0.5)">Capture High Resolution Image</button>
</p></center>
</form>

<center><div id="myDIV" style="display: none" class="blink_me"><p>Capturing...</p></div></center>
<center><div id="myDIV2" style="display: none" class="blink_me"><p>Updating...</p></div></center>

<script>
function myFunction1() {
    var s = document.getElementById("myValue");
    s.value = "capture";
    document.getElementById("myDIV").style.display = "block";
    document.getElementById("myBut").style.display = "none";
}
</script>

<script>
function myFunction2() {
        document.getElementById("myBut3").style.display = "block";
        var x = document.getElementById("mySelect").value;
        if (x=="on"){
            $.ajax({url: "write_file_.php?file=monitor.tmp&data=on"});
            var image = document.createElement("img");
            image.setAttribute("id", "mini");
	        image.setAttribute("src", "mini.jpg?t=" + new Date().getTime());
            image.setAttribute("width", "100%");
            image.setAttribute("height", "100%");
            image.setAttribute("onload", 'setTimeout(function() {src = src.substring(0, (src.lastIndexOf("?")+2))+(new Date()).getTime()}, 300)');
            image.setAttribute("onerror", 'setTimeout(function() {src = src.substring(0, (src.lastIndexOf("?")+2))+(new Date()).getTime()}, 5000)');
            document.getElementById("mon").appendChild(image);
        }
        if (x=="off"){
            document.getElementById("myBut3").style.display = "none";
            $.ajax({url: "write_file_.php?file=monitor.tmp&data=off"});
            var elem = document.getElementById("mini");
            if (elem && elem.parentNode) {
                elem.parentNode.removeChild(elem);
            }
        }
$.ajaxSetup({ cache: false });
}
</script>

<script>
function myFunction3() {
    var s = document.getElementById("myValue");
    s.value = "setup_monitor";
    document.getElementById("myDIV2").style.display = "block";
    document.getElementById("myBut3").style.display = "none";
}
</script>


<?php
echo '<script>myFunction2()</script>';

if ($b1=="setup_monitor"){
    file_put_contents('onoff.tmp', 'setup_monitor');
}

if ($b1=="capture"){
    file_put_contents('libre.tmp', 'off');
    file_put_contents('onoff.tmp', 'on');
    $libre = file_get_contents('libre.tmp');
    while ($libre=="off"){
        $libre = file_get_contents('libre.tmp');
        usleep(100000);
    }
    echo '<img src="pic.jpg?' . time() . '" class="bigimg">';
    function cbs($size){
        $base = log($size) / log(1024); 
        $suffix = array("", "KBytes", "MBytes."); 
        $f_base = floor($base);
        return round(pow(1024, $base - floor($base)), 2) . $suffix[$f_base];
    }
    $fsize=cbs(filesize("pic.jpg"));
    echo '<center><p>Image size: '.$fsize.'</p></center><br>';
}
?>

</div></div>
<?php
if( !isset( $_SERVER['HTTP_USER_AGENT'])){$name = "none";}else
{$useragent = strtolower($_SERVER['HTTP_USER_AGENT']);}
if (preg_match("/mobile/i", $useragent) || preg_match("/tablet/i", $useragent) || preg_match("/android/i", $useragent) || preg_match("/samsung/i", $useragent) || preg_match("/iphone/i", $useragent)|| preg_match("/sony/i", $useragent)|| preg_match("/ipad/i", $useragent)){
echo '<script src="pinch-zoom.js"></script><script>var el = document.querySelector(".pinch-zoom"); new PinchZoom.default(el, {});</script>';}
?>
</body>
</html>
